# AgentHarness Developer Guide (Repo Root)

## Purpose
AgentHarness is a PySide6 desktop app that runs a multi-phase, LLM-driven development workflow. This guide explains entry points, runtime artifacts, and where to implement common changes.

## Top-Level Map
- `main.py`: Application entry point. Creates `QApplication` and shows `MainWindow`.
- `src/`: All application code (GUI, core workflow, workers, LLM integration, utils).
- `test.txt`: simple text placeholder currently containing a greeting string.
- `TODO's`: Product backlog and feature notes that map into code.
- `Product Description`: Product vision and UX goals.
- `requirements.txt`: Runtime dependencies (PySide6).
- `update_markdown_files_with_llm.bat`: Interactive batch runner that scans all `.md` files recursively and sends an update prompt per file to a selected CLI (`claude`, `codex`, or `gemini`), while streaming live CLI output in the same terminal.
- `AGENTS.md`: Repo-specific assistant rules.
- `CLAUDE.md`: Workflow notes and architecture overview.
- `GEMINI.md`: Workflow notes and architecture overview for Gemini.
- `.gitignore`: Ignore rules (keep temp dirs ignored).
- `.idea/`, `.claude/`, `.venv/`, `.git/`: Local tools, settings, and VCS metadata.

## Workflow Overview (High Level)
1. On launch, the app first requires selecting a working directory (with recent-directory shortcuts). After selection, the UI uses a strict two-column layout: left panel (optional tabs) and right panel (chat only). The left panel can show up to 3 independently toggleable tabs via the `View` menu: Logs, Description (read-only preview), and Tasks (with All/Completed/Incomplete filters). The left panel only appears when at least one tab is enabled. The right column contains ONLY the chat panel (always visible as the primary input method). Workflow commands are available from the `Workflow` menu and menu bar icon buttons (Start, Pause, Stop, Next Step in top-right corner). Control buttons row has been removed - all workflow controls are accessible via menu bar icons and Workflow menu. Start is available from those controls when there are incomplete tasks in tasks.md (including after the workflow reaches Completed or Cancelled), and also when post-question answers are already submitted and ready to move directly into planning. Pause resumes from the same phase/sub-phase. Stop cancels the run, and a later Start begins a fresh main-loop run from incomplete tasks. Project switching is available from `File -> Open Project...` and reuses the same startup picker with recent-directory shortcuts. Execution controls are edited from `Settings -> Configuration Settings`, LLM provider/model choices from `Settings -> LLM Settings` (selections persist when that dialog closes and can be exported/imported as reusable JSON configs), and review type selection from `Settings -> Review Settings`. The chat panel remains the primary input method, and direct description editing is available from the post-question decision dialog via `Edit Product Description` (dedicated editor window). The chat panel includes 3 checkboxes to control LLM behavior: "Update description" (updates product-description.md), "Add tasks" (adds tasks to tasks.md), and "Provide answer in text" (writes response to answer.md). While product description is empty, these checkboxes are disabled and the send button text is `Create initial description`; after description exists, checkboxes are enabled and the button text is `Send Message`. When opening a non-empty folder with empty description content, the app can prompt to bootstrap `product-description.md` from the existing codebase and lets the user choose provider/model for that one-time generation pass. Chat input shortcuts are `Enter` to send and `Shift+Enter` to insert a newline. Chat history is shown as chatbot-style user/bot bubbles (different colors) with one-line status text instead of log-like rows. Chat auto-scroll follows new content only when the view is near the bottom, so users can scroll up to inspect older messages without being forced back down by activity updates; activity spinner timer redraws are also paused while the view is away from bottom so manual scrolling remains responsive during long-running LLM calls. If in-memory description state is empty at send time, chat handling first re-reads `product-description.md` from disk and uses it when present; only when description is truly empty does first-message initialization run. When product description is empty, the first chat message is saved as the original `product-description.md` text and question generation is triggered (if max_questions > 0) before any LLM-based rewrite of that description. When description exists, chat messages are processed based on checkbox selections using specialized prompts (see CHECKBOX_PROMPTS.md for all 6 prompt combinations), or with a no-checkbox headless wrapper prompt that tells the LLM the user only sees `answer.md` and includes the user message. During long-running work, the chat panel shows an animated spinner activity row with friendly rotating status text tailored to the current phase (question generation, planning, planning-phase research, execution, unit-test prep, review/fix, git operations, and client message handling). Phrase pools for these contexts are intentionally larger so the spinner can cycle through more varied, phase-appropriate lines during long main-loop runs. During workflow execution it also posts explicit completion milestone bubbles (for example completed task planning, completed tasks list, validated unit tests, completed review phase, and completed git operations). When the LLM leaves `answer.md` empty, the chat panel always posts a status bubble: task-only updates point users to the Tasks tab, description-only updates point users to the Description tab, combined updates mention both tabs, and if neither `tasks.md` nor `product-description.md` changed it shows "nothing done". The description panel provides two view modes: `Preview` (Markdown rendering, default) and `Task List` (shows current action, completed/incomplete task counts and tabbed task lists with All/Completed/Incomplete filters). Edit mode removed from the main layout. After Q&A answers are submitted, only the current Q&A batch is rewritten into `product-description.md` using `PromptTemplates.format_definition_rewrite_prompt`; only this rewrite step pushes file content back into the GUI and adds a chat confirmation bubble that the description was updated from the submitted answers. Stored Q&A context is then cleared so the rewritten description is treated as the new initial input. After each rewrite, a non-modal decision dialog keeps the flow paused until the user explicitly selects one of four actions: `Ask More Questions`, `Edit Product Description`, `Continue`, or `Start Main Loop`. In this state the phase label shows `Ready to Continue` instead of `Awaiting Answers`. During a run, configuration and LLM selections remain editable and are applied to upcoming phases and iterations. Once the main loop starts, the description panel automatically switches to Task List mode and shows the view controls, displaying live agent action plus tabbed Markdown-rendered task lists (All/Completed/Incomplete) in the full content area, and the top-right percent is driven by task completion ratio from `tasks.md` with phase-weighting per cycle (execution/review/git) so full credit for newly completed tasks appears after git completes. Users can send client messages via the always-visible chat panel at any time when a working directory is active. During workflow execution, messages queue and are processed at iteration boundaries after git operations; when processed during workflow, if description is updated, tasks are automatically regenerated. When the workflow is idle, messages are processed immediately and update description/tasks as needed. External edits to product-description.md are detected via file watcher; expected rewrite-time edits are auto-loaded silently, while unexpected edits prompt the user to choose `Load External Changes` or `Keep Current Description` (which overwrites the file with current UI text).
2. When a working directory is selected (including the startup default), UI config handling ensures the directory is a git repo (`git init` if needed), surfaces a user-facing notice when git is missing, and configures `origin` if a remote URL is set. If `tasks.md` already has incomplete checklist items, the UI prompts whether to complete them; accepting that prompt triggers a second dialog asking for the number of iterations to run, then automatically starts the workflow and resumes directly from main execution on existing tasks. The same git readiness check is run again when the user starts planning from the question flow. A "Resume Tasks" button appears in the status panel when there are incomplete tasks and the workflow is idle, completed, or cancelled; clicking this button prompts for iteration count and then jumps directly into main execution. When max iterations are reached but incomplete tasks remain, a popup dialog with system beep prompts the user to specify additional iterations or complete the workflow.
3. `StateMachine` tracks phase/context with no machine-specific default working directory; `MainWindow` dispatches workers and updates context working directory immediately when the selected directory changes.
4. Question generation initializes an empty `questions.json` and expects the LLM to write a batch into it in a single attempt (no stdout parsing or fallback prompts). When questions are ready, the app opens a modal question window that supports Up/Down answer selection, Left/Right question navigation, and Enter submit/advance; Enter on the last question submits and closes the window. The question window does not allow manual close (`Esc`/window close) before final submission.
5. Description molding runs after answers are submitted: it rewrites Q&A plus the current description into `product-description.md` using the dedicated `description_molding` stage/model; this step is file-first (`product-description.md` updates the UI, not the other way around).
6. Task planning now includes a post-planning research pass: planning writes `tasks.md` first, then the selected `research` stage/model fills `research.md` using both `product-description.md` and `tasks.md`.
7. Main execution completes a configurable number of tasks per iteration (controlled by `tasks_per_iteration`, default 1) and updates `recent-changes.md`.
8. When a valid working directory is active (including the startup default path), initialization ensures `review/` exists with one file per active review type; the review phase executes in this order: (1) optional unit test prep (runs FIRST if enabled, uses `git diff` to decide whether tests should be added/edited), (2) review/fix cycles per review type (General, Functionality, Architecture, Efficiency, Error Handling, Safety, Testing, Documentation, UI/UX). The review settings dialog separates this one-time pre-review prep control from per-iteration review-loop type selection for clarity. The review loop writes findings to the active file only, skips fixer when that file is empty, and truncates the active file after each completed fix cycle. Review iteration limits and reviewer/fixer/unit-test-prep selections are read between cycles, so reducing loop count or switching agents takes effect without restarting.
9. Git operations run as a hybrid flow: code captures `git status --porcelain` plus a `git diff` snapshot and injects them into the git prompt, the LLM writes only a commit message into `.agentharness/git-commit-message.txt`, and the app performs `git add`, `git commit`, and optional `git push` in code; after a successful commit the message file is truncated.
10. Post-git loop continuation is handled in `src/gui/workflow_runner.py`; the handoff back to main execution now includes recovery guards for malformed git result payloads and `tasks.md` read failures, with best-effort file recreation and explicit error-state transition on unexpected exceptions. Error-recovery skip actions now route using the original failed phase (not `Phase.ERROR`) and first transition out of error to `IDLE` so skip can continue loop flow correctly.
11. Debug step mode is controlled from `Settings -> Debug Settings`: stage-specific before/after breakpoints pause right before or right after each LLM call until the user clicks `Next Step`.
12. Debug settings also control whether per-call live terminal windows are shown on Windows and whether the left logs panel is visible. New/default projects start with the left logs panel hidden.
13. Start/Play controls remain available whenever the workflow is not actively running (`IDLE`, `PAUSED`, `COMPLETED`, `CANCELLED`, or `ERROR`) and no worker is active, so users can restart after failures without being blocked by phase state.

## Working-Directory Artifacts
Created in the selected working directory (not the repo root):
- `tasks.md`: Task checklist and completion state.
- `recent-changes.md`: Rolling log of code changes.
- `review/`: Per-review-type findings files (for example `review/general.md`, `review/architecture.md`, `review/ui_ux.md`).
- `product-description.md`: Synced project description from the UI.
- `product-description.md`: Q&A-rewritten product definition used for task planning.
- `research.md`: Post-planning product/domain research generated from `product-description.md` and `tasks.md` for developer context.
- `session_state.json`: Pause/resume snapshot of workflow state.
- `questions.json`: Batch questions file.
- `answer.md`: LLM responses to client messages (gitignored).
- `AGENTS.md`, `CLAUDE.md`, `GEMINI.md`: Governance prompt files; auto-created if missing.
- `.agentharness/live-llm/*.log`: Per-run live output logs used to mirror LLM execution into popup terminal windows.
- `.agentharness/git-commit-message.txt`: Startup-initialized commit message target for the git-ops LLM step; truncated after successful code-driven commit.
- `.agentharness/chat-history.json`: Rolling log of user/bot chat messages (up to the configured limit, default 50). Loaded when a project opens, appended on every user or bot message, reset to `[]` via `/clear`. Managed by `src/core/chat_history_manager.py`.
- `.agentharness/project-settings.json`: Per-working-directory persisted UI settings, loaded automatically when the directory is selected and saved when the app closes.

## TODO-to-File Map
Use this when picking up items from `TODO's`.
- Save full session state / resume later: `src/core/session_manager.py`, `src/core/state_machine.py`, `src/gui/main_window.py`, `src/gui/widgets/config_panel.py`.
- Warn when debug loop iterations are 0 at Start: `src/gui/main_window.py`, `src/gui/widgets/config_panel.py`.
- Detect Gemini quota errors and prompt for LLM switch: `src/workers/llm_worker.py`, `src/llm/gemini_provider.py`, `src/core/exceptions.py`, `src/gui/main_window.py`.
- Detect Claude quota errors and prompt for LLM switch: `src/workers/llm_worker.py`, `src/llm/claude_provider.py`, `src/core/exceptions.py`, `src/gui/main_window.py`.
- Add or adjust review types/settings UI or optional pre-review unit-test-update behavior: `src/llm/prompt_templates.py`, `src/core/state_machine.py`, `src/core/project_settings.py`, `src/gui/widgets/config_panel.py`, `src/gui/dialogs/review_settings_dialog.py`, `src/workers/review_worker.py`.
- Flag files per step and skip review iterations on "all clear": `src/core/file_manager.py`, `src/workers/review_worker.py`, `src/gui/main_window.py`.
- Reset state on app relaunch (clear questions.json, etc): `src/gui/main_window.py`, `src/core/file_manager.py`, `src/workers/question_worker.py`.
- Show generated description and task checklist/progress in UI: `src/workers/planning_worker.py`, `src/gui/widgets/description_panel.py` (multi-mode panel with Edit/Preview/Task List modes and automatic mode switching during iteration), `src/gui/widgets/status_panel.py`, `src/gui/main_window.py`, `src/core/file_manager.py` (read_description method).
- Fix log filtering for existing log lines: `src/gui/widgets/log_viewer.py`.
- Planning loop with multiple passes: `src/workers/planning_worker.py`, `src/gui/main_window.py`, `src/llm/prompt_templates.py`.
- Allow new prompt after completion and re-enable controls: `src/gui/main_window.py`, `src/core/state_machine.py`.
- Auto-create CLAUDE/AGENTS/GEMINI files: `src/core/file_manager.py`, `src/gui/main_window.py`.
- Ensure fixer updates recent-changes.md when it edits code: `src/llm/prompt_templates.py`, `src/workers/review_worker.py`.
- Handle UI app runs that block (timeouts or guidance): `src/llm/prompt_templates.py`, `src/workers/llm_worker.py`.
- Keep recent-changes.md capped (no reset each task): `src/core/file_manager.py`, `src/gui/main_window.py`.
- UI action to add tasks: `src/gui/widgets/config_panel.py`, `src/gui/main_window.py`, `src/utils/markdown_parser.py`, `src/core/file_manager.py`.
- Update questions.json when answers are submitted: `src/gui/main_window.py`, `src/workers/question_worker.py`.
- Review prompts should leave the active per-type review file empty when no issues: `src/llm/prompt_templates.py`, `src/workers/review_worker.py`.
- Investigate slowness (timeouts/sequencing): `src/workers/llm_worker.py`, `src/gui/main_window.py`, `src/workers/`.
- Stop review loop early when all reviews empty: `src/workers/review_worker.py`, `src/gui/main_window.py`.
- Multi-LLM review pipelines: `src/gui/widgets/llm_selector_panel.py`, `src/gui/widgets/config_panel.py`, `src/workers/review_worker.py`, `src/core/state_machine.py`, `src/core/project_settings.py`.
- Add more LLMs/models and API key handling: `src/llm/base_provider.py`, `src/llm/*_provider.py`, `src/gui/widgets/llm_selector_panel.py`, `src/core/project_settings.py`.
- Review ordering (general to specific): `src/llm/prompt_templates.py`, `src/workers/review_worker.py`.
- Continue after completion (more iterations or new feature): `src/gui/main_window.py`, `src/core/state_machine.py`, `src/gui/widgets/config_panel.py`.
- Capture UI screenshots for debugging: `src/gui/main_window.py`, `src/gui/widgets/log_viewer.py`.
- Let LLM choose review types dynamically: `src/llm/prompt_templates.py`, `src/workers/review_worker.py`, `src/gui/widgets/config_panel.py`.
- Dedicated "add tasks" pass after iterations: `src/workers/execution_worker.py` (or new worker), `src/utils/markdown_parser.py`, `src/core/file_manager.py`, `src/gui/main_window.py`.

## Change Map
- App startup: `main.py`, `src/gui/main_window.py`.
- Workflow state and persistence: `src/core/state_machine.py`, `src/core/session_manager.py`.
- LLM prompts and providers: `src/llm/`.
- LLM provider CLI flags, commands, and curated model IDs used by the UI: `src/llm/*_provider.py`. Codex supports reasoning effort levels (low, medium, high, xhigh) via model ID suffixes (e.g., `:high`).
- Default per-stage LLM provider/model assignments (including `description_molding`, `research`, and `unit_test_prep`): `src/gui/widgets/llm_selector_panel.py` (UI defaults) and `src/core/state_machine.py` (`StateContext` fallback). Current baseline defaults are the codex/claude profile defined in `llm-config-codex-claude.json`.
- LLM output capture and prompt transport behavior (argv vs stdin/output-file), including subprocess cwd validation/fallback when configured paths are invalid: `src/workers/llm_worker.py`, `src/llm/*_provider.py` (Claude, Gemini, and Codex use stdin prompts). Codex provider runs now pass `--cd <working_directory>` and `--add-dir <working_directory>` so sandbox write scope follows the selected project directory tree. Current defaults: 600-second base timeout, 1200-second execution-stage timeout override, and 4-second retry delay for retrying worker calls.
- Debug stepping/breakpoints and terminal popup visibility: `src/core/debug_settings.py`, `src/gui/dialogs/debug_settings_dialog.py`, `src/gui/main_window.py`, `src/workers/llm_worker.py`.
- Review label formatting in UI/logs: `src/gui/main_window.py` (uses `PromptTemplates.get_review_display_name`).
- Background phase logic: `src/workers/`.
- UI/UX components and global styling: `src/gui/` (`src/gui/theme.py` provides shared stylesheet, typography scale, button variants, Markdown display styling, and fade-in helpers; `src/gui/dialogs/llm_settings_dialog.py` hosts stage provider/model selection; `src/gui/widgets/task_loop_panel.py` renders loop-centered Markdown task completion state; `src/gui/widgets/description_panel.py` provides single-box description editing/Markdown preview modes).
- GUI worker orchestration: `src/gui/main_window.py`, `src/gui/workflow_runner.py` (includes chat-message completion handling that clears residual chat activity indicators and refreshes task counts/lists immediately when `tasks.md` changes).
- Settings save/load and debug settings menu wiring (left logs panel defaults to hidden until enabled): `src/gui/settings_mixin.py`.


